# –ú–æ–¥—É–ª—å Agent - –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## üìã –û–±–∑–æ—Ä

–ú–æ–¥—É–ª—å `src/services/agent.ts` –±—ã–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–æ–µ–∫—Ç. –û–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≥–µ–Ω—Ç—Å–∫–∏–º–∏ –∫–ª—é—á–∞–º–∏ Hyperliquid —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º secp256k1 –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏.

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç—Å–∫–∏—Ö –∫–ª—é—á–µ–π
- **`generateAgent()`**: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π secp256k1 –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (32 –±–∞–π—Ç–∞, hex)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç `{ priv, pub, address }` –≥–¥–µ:
  - `priv` - –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –≤ hex —Ñ–æ—Ä–º–∞—Ç–µ
  - `pub` - —Å–∂–∞—Ç—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤ hex —Ñ–æ—Ä–º–∞—Ç–µ  
  - `address` - EVM-–∞–¥—Ä–µ—Å —Å checksum (EIP-55)

### 2. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ
- **`saveAgentEncrypted({ priv }, pin)`**: –®–∏—Ñ—Ä—É–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –≤ IndexedDB
- **`loadAgentEncrypted(pin)`**: –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
- **`hasAgent()`**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–ª—é—á–∞
- **`resetAgent()`**: –£–¥–∞–ª—è–µ—Ç –∫–ª—é—á –∏ salt

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WebCrypto API –¥–ª—è AES-GCM —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
- PBKDF2 —Å 100,000 –∏—Ç–µ—Ä–∞—Ü–∏–π –¥–ª—è –≤—ã–≤–æ–¥–∞ –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏–∑ PIN
- Salt –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞

### 4. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- **`getAgentAddress({ priv })`**: –ü–æ–ª—É—á–∞–µ—Ç EVM-–∞–¥—Ä–µ—Å –∏–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
- **`getAgentPublic({ priv })`**: –ü–æ–ª—É—á–∞–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –∏–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ
- **`ensureAgent(pin)`**: –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞–≥–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–ª—é—á–∞

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —É—Ç–∏–ª–∏—Ç—ã (`src/utils/crypto.ts`)
- `deriveKeyFromPin(pin, salt)` - PBKDF2 –≤—ã–≤–æ–¥ –∫–ª—é—á–∞
- `aesGcmEncrypt(data, key)` - AES-GCM —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
- `aesGcmDecrypt(encryptedData, key, iv)` - AES-GCM —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
- `generateSalt()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ salt
- `validatePin(pin)` - –≤–∞–ª–∏–¥–∞—Ü–∏—è PIN (–º–∏–Ω–∏–º—É–º 6 –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ-—Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤)

### –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- **IndexedDB**: `HyperliquidAgentDB` —Å store `agentKeys`
- **localStorage**: —Ö—Ä–∞–Ω–µ–Ω–∏–µ salt –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- **ID**: `hl_agent_key_v1` –¥–ª—è –∞–≥–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–ª—é—á–∞

### –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
```typescript
interface AgentKey {
  priv: string;    // Private key (32 bytes, hex)
  pub: string;     // Compressed public key (hex)
  address: string; // EVM address (checksum)
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- `vitest@1.3.1` - —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- `@vitest/ui@1.3.1` - UI –¥–ª—è —Ç–µ—Å—Ç–æ–≤
- `jsdom` - DOM –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤

### –¢–µ—Å—Ç—ã (`src/services/__tests__/agent.test.ts`)
- ‚úÖ **13 —Ç–µ—Å—Ç–æ–≤** - –≤—Å–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ
- –ü–æ–∫—Ä—ã—Ç–∏–µ: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ/–¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ú–æ–∫–∏ –¥–ª—è WebCrypto API, IndexedDB, localStorage

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
npm run test        # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
npm run test:ui     # UI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
npm run test:run    # –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫
```

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `src/services/agent.ts` - –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –∞–≥–µ–Ω—Ç–∞
- `src/utils/crypto.ts` - –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —É—Ç–∏–ª–∏—Ç—ã
- `src/utils/hlSign.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ `AgentKey`
- `src/services/trade.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- `src/components/SetupAgent.tsx` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- `src/app/trade-sandbox/page.tsx` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
- –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–∏–ø—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
```typescript
import { generateAgent, ensureAgent } from '@/services/agent';

// –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
const agent = await generateAgent();

// –ò–ª–∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
const agent = await ensureAgent('myPin123');
```

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ/–¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
```typescript
import { saveAgentEncrypted, loadAgentEncrypted } from '@/services/agent';

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á
await saveAgentEncrypted({ priv: agent.priv }, 'myPin123');

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å
const { priv } = await loadAgentEncrypted('myPin123');
```

## üìä –°—Ç–∞—Ç—É—Å

- ‚úÖ **–ú–æ–¥—É–ª—å –∞–≥–µ–Ω—Ç–∞**: –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- ‚úÖ **–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —É—Ç–∏–ª–∏—Ç—ã**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã  
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: 13 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ
- ‚úÖ **–°–±–æ—Ä–∫–∞**: –ü—Ä–æ–µ–∫—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ **–¢–∏–ø–∏–∑–∞—Ü–∏—è**: –ü–æ–ª–Ω–∞—è TypeScript –ø–æ–¥–¥–µ—Ä–∂–∫–∞

## üîÆ –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ IndexedDB** (—Å–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–æ–∫–∏)
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å backup/restore** –∞–≥–µ–Ω—Ç—Å–∫–∏—Ö –∫–ª—é—á–µ–π
3. **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤** —Å —Ä–∞–∑–Ω—ã–º–∏ PIN
4. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –∫–ª—é—á–µ–π
5. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–≥–µ–Ω—Ç—Å–∫–∏—Ö –∫–ª—é—á–µ–π

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú–æ–¥—É–ª—å –∞–≥–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å–æ–≥–ª–∞—Å–Ω–æ –≤—Å–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º:
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è secp256k1 –∫–ª—é—á–µ–π
- ‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ AES-GCM —Å PBKDF2
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ IndexedDB
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è PIN (6+ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ-—Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
- ‚úÖ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

–ú–æ–¥—É–ª—å –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Ç–æ—Ä–≥–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É Hyperliquid.
